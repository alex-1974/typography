\RequirePackage{l3keys2e,xparse}
\ProvidesExplPackage{typography} {2022/12/09}{1.0} {Commands related to typography}

% There are two possible approaches here. 
% If you want to allow a function to be used 'inside' something like the second argument of \int_set:Nn 
% then it has to be expandable. That means it has to use only other functions which are themselves expandable,
% which in expl3 means that they are marked in interface3 with a star.

\ExplSyntaxOn

% Define constants
\fp_const:Nn \c_typo_golden_ratio_fp { \fp_eval:n { (1+sqrt(5)) / 2} }
\tl_const:Nn \c_typo_alphabet_tl {abcdefghijklmnopqrstuvwxyz}
\tl_const:Nn \c_typo_cap_chars_tl {HI}
\tl_const:Nn \c_typo_x_chars_tl {x}
\tl_const:Nn \c_typo_height_chars_tl {HIyjqpg}

\makeatletter
% expandable function
\cs_new:Npn \typo_get_document_fontsize: {
	\dim_eval:n { \f@size pt } 
}
\cs_new:Npn \typo_set_document_fontsize:N #1 {
	\dim_set:Nn #1 { \f@size pt } 
}
\makeatother

% Get cap height
% #1 font parameter
\cs_new:Npn \typo_get_capheight:n #1 {
	\vbox_set:Nn \l_tmpa_box { #1 \c_typo_cap_chars_tl }
	\dim_eval:n { \box_ht:N \l_tmpa_box }
}
% Set cap height
% #1 variable name
% #2 font parameter
\cs_new_protected:Npn \typo_set_capheight:Nn #1#2 {
	\group_begin:
		\vbox_set:Nn \l_tmpa_box { #2 \c_typo_cap_chars_tl }
		\exp_args:NNNe
	\group_end:
	\dim_set:Nn #1 { \dim_eval:n { \box_ht:N \l_tmpa_box } }
}

% Get x height
% #1 font parameter
\cs_new:Npn \typo_get_xheight:n #1 {
	\vbox_set:Nn \l_tmpa_box { #1 \c_typo_x_chars_tl }
	\dim_eval:n { \box_ht:N \l_tmpa_box }
}
% Set x height
% #1 variable name
% #2 font parameter
\cs_new_protected:Npn \typo_set_xheight:Nn #1#2 {
	\group_begin:
		\vbox_set:Nn \l_tmpa_box { #2 \c_typo_x_chars_tl }
		\exp_args:NNNe
	\group_end:
	\dim_set:Nn #1 { \dim_eval:n { \box_ht:N \l_tmpa_box } }
}

% Get total height
% #1 font parameter
\cs_new:Npn \typo_get_totalheight:n #1 {
	\vbox_set:Nn \l_tmpa_box { #1 \c_typo_height_chars_tl }
	\dim_eval:n { \box_ht_plus_dp:N \l_tmpa_box }
}
% Set total height
% #1 variable name
% #2 font parameter
\cs_new_protected:Npn \typo_set_totalheight:Nn #1#2 {
	\group_begin:
		\vbox_set:Nn \l_tmpa_box { #2 \c_typo_height_chars_tl }
		\exp_args:NNNe
	\group_end:
	\dim_set:Nn #1 { \dim_eval:n { \box_ht_plus_dp:N \l_tmpa_box } }
}

% Set x ratio
% #1 variable name
% #2 font parameter
\cs_new_protected:Npn \typo_set_xratio:Nn #1#2 {
	\group_begin:
	\vbox_set:Nn \l_tmpa_box { #2 \c_typo_cap_chars_tl }
	\vbox_set:Nn \l_tmpb_box { #2 \c_typo_x_chars_tl }
	\exp_args:NNNe
	\group_end:
	\fp_set:Nn #1 { \dim_ratio:nn { \box_ht:N \l_tmpb_box } { \box_ht:N \l_tmpa_box } }
}
% Get x ratio
% #1 font parameter
\cs_new:Npn \typo_get_xratio:n #1 {
	\vbox_set:Nn \l_tmpa_box { #1 \c_typo_cap_chars_tl }
	\vbox_set:Nn \l_tmpb_box { #1 \c_typo_x_chars_tl }
	\fp_eval:n { \dim_ratio:nn { \box_ht:N \l_tmpb_box } { \box_ht:N \l_tmpa_box } }
}

\cs_new:Npn \typo_get_mu:n #1 {
	\dim_zero_new:N \acw_dim
	\dim_zero_new:N \fsize_dim
	\typo_set_avg_charwidth:Nn {\acw_dim}{ #1 }
	\typo_set_totalheight:Nn {\fsize_dim}{#1}
	\fp_eval:n { \dim_ratio:nn { \fsize_dim }{ \acw_dim } }
}

\cs_new_protected:Npn \typo_set_mu:Nn #1#2 {
	\group_begin:
	\dim_zero_new:N \acw\dim
	\dim_zero_new:n \fsize_dim
	\typo_set_avg_charwidth:Nn {\acw_dim}{ #2 }
	\typo_set_totalheight:Nn {\fsize_dim}{#2}
	\exp_args:NNNe
	\group_end:
	\fp_set:Nn #1 { \fp_eval:n { \fsize_dim / \acw_dim }}
}

% Get average charwidth
% #1 font parameter
\cs_new_protected:Npn \typo_get_avg_charwidth:n #1 {
	\hbox_set:Nn \l_tmpa_box { #1 \c_typo_alphabet_tl }
	\dim_eval:n { \box_wd:N \l_tmpa_box  / \tl_count:N \c_typo_alphabet_tl }
}
% Set average charwidth
% #1 variable name
% #2 font parameter
\cs_new_protected:Npn \typo_set_avg_charwidth:Nn #1#2 {
	\group_begin:
		\hbox_set:Nn \l_tmpa_box { #2 \c_typo_alphabet_tl }
		\exp_args:NNNe 
	\group_end:
	\dim_set:Nn #1 { \dim_eval:n { \box_wd:N \l_tmpa_box } / \tl_count:N \c_typo_alphabet_tl } 
}
\exp_args_generate:n {NNe}

% Get document fontsize in pt
\NewDocumentCommand\documentFontsize {} {
	\typo_document_fontsize:
}

\NewDocumentCommand\setAverageCharWidth { O{} m } {
	\typo_set_avg_charwidth:Nn #2 {#1}
}
\NewDocumentCommand\setCapHeight { O{} m } {
	\typo_set_capheight:Nn #2 {#1}
}
\NewDocumentCommand\getCapHeight { O{} } {
	\typo_get_capheight:n {#1}
}
\NewDocumentCommand\setxHeight { O{} m } {
	\typo_set_xheight:Nn #2 {#1}
}
\NewDocumentCommand\getxHeight { O{} } {
	\typo_get_xheight:n {#1}
}
\NewDocumentCommand\setTotalHeight { O{} m } {
	\typo_set_totalheight:Nn #2 {#1}
}
\NewDocumentCommand\getTotalHeight { O{} } {
	\typo_get_totalheight:n {#1}
}

% Set lengths
%% Set charwidth
%\dim_new:N \__cw_dim
%\typo_avg_charwidth:n { \__cw_dim }{}
%\AtBeginDocument{

%}
%\dim_new:N \charwidth
%\dim_set:Nn \charwidth { \averageCharWidth {} }


% #1 variable name
% #2 linewidth (in cpl)
% #3 width factor (34)
% #4 font parameter
\cs_new_protected:Npn \typo_lineheight:Nnnn #1#2#3#4 {
	\group_begin:
	\int_zero_new:N \cpl_int
	\int_zero_new:N \wf_int
	\fp_zero_new:N \xratio_fp
	\dim_zero_new:N \fsize_dim
	% linewidth (in cpl)
	\fp_set:Nn \cpl_int {#2}
	% width factor (34)
	\int_set:Nn \wf_int {#3}
	% x-ratio
	\typo_set_xratio:Nn \xratio_fp {#4}
	% fsize
	\typo_set_totalheight:Nn \fsize_dim {#4}
	% x-height correction
	\fp_set:Nn \xhc_fp { (\xratio_fp - (\c_typo_golden_ratio_fp - 1)) / \c_typo_golden_ratio_fp }
	
	\fp_zero_new:N \qa_fp
	\fp_zero_new:N \qb_fp
	\fp_zero_new:N \xhc_fp
	% lower boundary
	\fp_set:Nn \qa_fp { 3 - \c_typo_golden_ratio_fp }
	\fp_set:Nn \qb_fp { 2 * \c_typo_golden_ratio_fp - 3 }
	\exp_args:NNNe
	\group_end:
	% This part does all the math behind the calculation of the optimal line height
	% Calculates the optimal line height depending on the font, 
	% defined by its x-ratio and character constants, 
	% respectively the font size and line width in characters per line
	\dim_set:Nn #1 { \fp_to_decimal:n { \fp_eval:n { 
		round(
		\fsize_dim * (
		 \qa_fp + 
		 ( \qb_fp * (\cpl_int / ( \fsize_dim * \wf_int )) ) +
		 \xhc_fp
		 )
		 ,2)
	} } pt}
}
\NewDocumentCommand\setLineheight { O{}mm } {
	\typo_lineheight:Nnnn #2{#3}{34}{#1}
} 

\NewDocumentCommand{\getFontname}{}
 {
  \str_set:Nx \l_tmpa_str { \fontname\font }
  \regex_replace_once:nnN { \:.* } { } \l_tmpa_str
  \regex_replace_once:nnN { \A \[(.*)\] \Z } { \1 } \l_tmpa_str
  \regex_replace_once:nnN { \.[^\.]* \Z } { } \l_tmpa_str
  \str_use:N \l_tmpa_str
 }
 
\newlength{\charwidth}
\setAverageCharWidth{\charwidth}
\newlength{\baseline}

\AtBeginDocument{
\typo_lineheight:Nnnn {\baseline}{66}{34}{}
}
\ExplSyntaxOff

